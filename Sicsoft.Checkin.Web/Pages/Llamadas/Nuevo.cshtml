@page
@model Boletaje.Pages.Llamadas.NuevoModel
@{
    ViewData["Title"] = "Crear Llamada Servicio";
}
@section breadcrumb{

    <li class="breadcrumb-item">
        <a asp-page="./Index">Llamadas Servicios</a>
    </li>
    <li class="breadcrumb-item active">
        <a>Agregar</a>
    </li>

}
@section styles{
    <style type="text/css">
        body {
            padding-top: 20px;
            padding-bottom: 20px;
        }

        #draw-canvas {
            border: 2px dotted #CCCCCC;
            border-radius: 5px;
            cursor: crosshair;
        }

        #draw-dataUrl {
            width: 100%;
        }

        h3 {
            margin: 10px 15px;
        }

        header {
            background: #273B47;
            height: 100%;
            width: 100%;
            padding: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        section {
            flex: 1;
        }

        h1 {
            margin: 10px 15px;
        }

        header {
            color: white;
            font-weight: 500;
            padding-left: 15px;
        }




        .contenedor {
            width: 100% margin: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .instrucciones {
            width: 90%;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        label {
            margin: 0 15px;
        }

        footer {
            background: #273B47;
            color: white;
            height: 100%;
            width: 100%;
            margin-top: 10px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }


        input[type=range] {
            -webkit-appearance: none;
            margin: 18px 0;
        }

            input[type=range]:focus {
                outline: none;
            }

            input[type=range]::-webkit-slider-runnable-track {
                width: 100%;
                height: 8.4px;
                cursor: pointer;
                animate: 0.2s;
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
                background: #3071a9;
                border-radius: 1.3px;
                border: 0.2px solid #010101;
            }

            input[type=range]::-webkit-slider-thumb {
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
                border: 1px solid #000000;
                height: 36px;
                width: 16px;
                border-radius: 3px;
                background: #ffffff;
                cursor: pointer;
                -webkit-appearance: none;
                margin-top: -14px;
            }

            input[type=range]:focus::-webkit-slider-runnable-track {
                background: #367ebd;
            }

            input[type=range]::-moz-range-track {
                width: 100%;
                height: 8.4px;
                cursor: pointer;
                animate: 0.2s;
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
                background: #3071a9;
                border-radius: 1.3px;
                border: 0.2px solid #010101;
            }

            input[type=range]::-moz-range-thumb {
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
                border: 1px solid #000000;
                height: 36px;
                width: 16px;
                border-radius: 3px;
                background: #ffffff;
                cursor: pointer;
            }

            input[type=range]::-ms-track {
                width: 100%;
                height: 8.4px;
                cursor: pointer;
                animate: 0.2s;
                background: transparent;
                border-color: transparent;
                border-width: 16px 0;
                color: transparent;
            }

            input[type=range]::-ms-fill-lower {
                background: #2a6495;
                border: 0.2px solid #010101;
                border-radius: 2.6px;
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            }

            input[type=range]::-ms-fill-upper {
                background: #3071a9;
                border: 0.2px solid #010101;
                border-radius: 2.6px;
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
            }

            input[type=range]::-ms-thumb {
                box-shadow: 1px 1px 1px #000000, 0px 0px 1px #0d0d0d;
                border: 1px solid #000000;
                height: 36px;
                width: 16px;
                border-radius: 3px;
                background: #ffffff;
                cursor: pointer;
            }

            input[type=range]:focus::-ms-fill-lower {
                background: #3071a9;
            }

            input[type=range]:focus::-ms-fill-upper {
                background: #367ebd;
            }
    </style>

}

@section scripts{


    <script type="text/javascript">

        /*
            El siguiente codigo en JS Contiene mucho codigo
            de las siguietes 3 fuentes:
            https://stipaltamar.github.io/dibujoCanvas/
            https://developer.mozilla.org/samples/domref/touchevents.html - https://developer.mozilla.org/es/docs/DOM/Touch_events
            http://bencentra.com/canvas/signature/signature.html - https://bencentra.com/code/2014/12/05/html5-canvas-touch-events.html
*/

        (function () { // Comenzamos una funcion auto-ejecutable

            // Obtenenemos un intervalo regular(Tiempo) en la pamtalla
            window.requestAnimFrame = (function (callback) {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimaitonFrame ||
                    function (callback) {
                        window.setTimeout(callback, 1000 / 60);
                        // Retrasa la ejecucion de la funcion para mejorar la experiencia
                    };
            })();

            // Traemos el canvas mediante el id del elemento html
            var canvas = document.getElementById("draw-canvas");
            var ctx = canvas.getContext("2d");


            // Mandamos llamar a los Elemetos interactivos de la Interfaz HTML
            //var drawText = document.getElementById("draw-dataUrl");
            //var drawImage = document.getElementById("draw-image");
            var clearBtn = document.getElementById("draw-clearBtn");
            /*  *//*  var submitBtn = document.getElementById("draw-submitBtn");*/
            clearBtn.addEventListener("click", function (e) {
                // Definimos que pasa cuando el boton draw-clearBtn es pulsado
                clearCanvas();
                // drawImage.setAttribute("src", "");
            }, false);
            // Definimos que pasa cuando el boton draw-submitBtn es pulsado
            //submitBtn.addEventListener("click", function (e) {
            //    var dataUrl = canvas.toDataURL();
            //    drawText.innerHTML = dataUrl;
            //    drawImage.setAttribute("src", dataUrl);
            //}, false);

            // Activamos MouseEvent para nuestra pagina
            var drawing = false;
            var mousePos = { x: 0, y: 0 };
            var lastPos = mousePos;
            canvas.addEventListener("mousedown", function (e) {
                /*
                  Mas alla de solo llamar a una funcion, usamos function (e){...}
                  para mas versatilidad cuando ocurre un evento
                */
                var tint = document.getElementById("color");
                var punta = document.getElementById("puntero");
                console.log(e);
                drawing = true;
                lastPos = getMousePos(canvas, e);
            }, false);
            canvas.addEventListener("mouseup", function (e) {
                drawing = false;
                $("#Firma").val(canvas.toDataURL());

            }, false);
            canvas.addEventListener("mousemove", function (e) {
                mousePos = getMousePos(canvas, e);
            }, false);

            // Activamos touchEvent para nuestra pagina
            canvas.addEventListener("touchstart", function (e) {
                mousePos = getTouchPos(canvas, e);
                console.log(mousePos);
                e.preventDefault(); // Prevent scrolling when touching the canvas
                var touch = e.touches[0];
                var mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, false);
            canvas.addEventListener("touchend", function (e) {
                e.preventDefault(); // Prevent scrolling when touching the canvas
                var mouseEvent = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(mouseEvent);
                $("#Firma").val(canvas.toDataURL());

            }, false);
            canvas.addEventListener("touchleave", function (e) {
                // Realiza el mismo proceso que touchend en caso de que el dedo se deslice fuera del canvas
                e.preventDefault(); // Prevent scrolling when touching the canvas
                var mouseEvent = new MouseEvent("mouseup", {});
                canvas.dispatchEvent(mouseEvent);
                $("#Firma").val(canvas.toDataURL());

            }, false);
            canvas.addEventListener("touchmove", function (e) {
                e.preventDefault(); // Prevent scrolling when touching the canvas
                var touch = e.touches[0];
                var mouseEvent = new MouseEvent("mousemove", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
                $("#Firma").val(canvas.toDataURL());
            }, false);

            // Get the position of the mouse relative to the canvas
            function getMousePos(canvasDom, mouseEvent) {
                var rect = canvasDom.getBoundingClientRect();
                /*
                  Devuelve el tamaño de un elemento y su posición relativa respecto
                  a la ventana de visualización (viewport).
                */
                return {
                    x: mouseEvent.clientX - rect.left,
                    y: mouseEvent.clientY - rect.top
                };
            }

            // Get the position of a touch relative to the canvas
            function getTouchPos(canvasDom, touchEvent) {
                var rect = canvasDom.getBoundingClientRect();
                console.log(touchEvent);
                /*
                  Devuelve el tamaño de un elemento y su posición relativa respecto
                  a la ventana de visualización (viewport).
                */
                return {
                    x: touchEvent.touches[0].clientX - rect.left, // Popiedad de todo evento Touch
                    y: touchEvent.touches[0].clientY - rect.top
                };
            }

            // Draw to the canvas
            function renderCanvas() {
                if (drawing) {
                    var tint = document.getElementById("color");
                    var punta = document.getElementById("puntero");
                    ctx.strokeStyle = tint.value;
                    ctx.beginPath();
                    ctx.moveTo(lastPos.x, lastPos.y);
                    ctx.lineTo(mousePos.x, mousePos.y);
                    console.log(punta.value);
                    ctx.lineWidth = punta.value;
                    ctx.stroke();
                    ctx.closePath();
                    lastPos = mousePos;
                }
            }

            function clearCanvas() {
                canvas.width = canvas.width;
            }

            // Allow for animation
            (function drawLoop() {
                requestAnimFrame(drawLoop);
                renderCanvas();
            })();

        })();

    </script>

    <script>
        var btn = document.getElementById('Guardar');
        function onGuardar() {
            btn.disabled = true;
            $("#formTipos").submit();
        }
    </script>
    <script>

        function rellenaProductos(lista) {
            var sOptions = '';

            $("#productos").html('');
            for (var i = 0; i < lista.length; i++)
            {

                sOptions += ' <option value="' + lista[i].itemCode + ' / ' + lista[i].manufSN + '">' + lista[i].itemCode  + ' - '+lista[i].itemName + ' - ' + lista[i].manufSN +'</option>';

                }
            $("#productos").html(sOptions);
        }

        function cambiarProducto() {

            var CardCode = $("#cardcode").val();
            CardCode = CardCode.split("/")[0];
            $.ajax({
                        type: 'GET',

                        url: '@Url.Page("Nuevo", "Productos")',
                        dataType: 'json',
                data: { idB: CardCode },
                        headers: {
                            RequestVerificationToken: $('input:hidden[name="__RequestVerificationToken"]').val()
                        },
                        success: function (json) {

                            console.log(json);

                            rellenaProductos(json);

                        },

                        beforeSend: function (xhr) {


                        },
                        complete: function () {

                        },
                        error: function (error) {

                        }
                    });

        }

    </script>

}

<form method="post" id="formTipos" role="form" novalidate class="needs-validation " enctype="multipart/form-data">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-sm-6">
                            <h5 class="title">Registro de Llamada</h5>
                        </div>

                        <div class="col-sm-6" style="text-align: right">

                            <a asp-page="/Llamadas/Index" class="nav-link text-dark" style="text-decoration: underline;"><i class="fas fa-reply "></i>  Regresar</a>

                        </div>
                    </div>


                </div>
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Cliente:</label>

                                <input type="text" list="cardcodes" class="form-control form-control-lg" id="cardcode" placeholder="Nombre Cliente" asp-for="Input.CardCode" onchange="javascript: cambiarProducto();">

                                <datalist id="cardcodes">
                                    @foreach (var item in Model.Clientes.Clientes)
                                    {
                                        <option value="@item.CardCode / @item.CardName"> </option>
                                    }
                                </datalist>
                                <a asp-page="/Client/Nuevo" style="text-decoration: underline;" class="nav-link" target="_blank">Crear Cliente</a>


                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Producto:</label>
                                <select id="productos" class="form-control" asp-for="Input.ItemCode" required>
                                    <option value="0">Seleccione</option>

                                </select>
                                <a asp-page="/Boletas/Nuevo" style="text-decoration: underline;" class="nav-link" target="_blank">Crear Tarjeta Equipo</a>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Estado:</label>
                                <select id="status" class="form-control" asp-for="Input.Status" required>
                                    <!-- <option value="0">Seleccione</option>-->
                                    @foreach (var item in Model.Status)
                                    {
                                        if (item.Nombre.ToLower().Contains("ABRIR"))
                                        {
                                            <option value="@item.idSAP" selected>@item.Nombre</option>

                                        }
                                        else
                                        {
                                            <option value="@item.idSAP">@item.Nombre</option>

                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Caso:</label>
                                <select id="tp" class="form-control" asp-for="Input.TipoCaso" required>
                                    <option value="0">Seleccione</option>
                                    @foreach (var item in Model.TP)
                                    {
                                        <option value="@item.idSAP">@item.Nombre</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Lugar Reparación:</label>
                                <select id="lReparacion" class="form-control" asp-for="Input.LugarReparacion" required>
                                    <option value="1">Taller</option>
                                    <option value="2">Visita</option>

                                </select>
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label>Sucursal de Recibo:</label>
                                <select id="sr" class="form-control" asp-for="Input.SucRecibo" required>
                                    <option value="0">Seleccione</option>
                                    @foreach (var item in Model.Sucursales)
                                    {
                                        <option value="@item.idSAP">@item.Nombre</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label>Sucursal de Retiro:</label>
                                <select id="srt" class="form-control" asp-for="Input.SucRetiro" required>
                                    <option value="0">Seleccione</option>
                                    @foreach (var item in Model.Sucursales)
                                    {
                                        <option value="@item.idSAP">@item.Nombre</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="col-sm-6">

                            <div class="form-group">
                                <label>Técnico:</label>
                                <select id="srt" class="form-control" asp-for="Input.Tecnico" required>
                                    <option value="0">Seleccione</option>
                                    @foreach (var item in Model.Tecnicos)
                                    {
                                        if (item.Nombre.ToLower().Contains("pendiente"))
                                        {
                                            <option value="@item.idSAP" selected>@item.Nombre</option>

                                        }
                                        else
                                        {
                                            <option value="@item.idSAP">@item.Nombre</option>

                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label>Horas:</label>
                                <input type="number" min="0" step="1" class="form-control" asp-for="Input.Horas" id="horas" required />
                            </div>
                        </div>

                    </div>


                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Asunto:</label>

                                <input type="text" class="form-control form-control-lg" id="asunto" placeholder="Asunto" asp-for="Input.Asunto">


                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Comentarios:</label>

                                <textarea class="form-control form-control-lg" id="comentarios" placeholder="Comentarios" asp-for="Input.Comentarios"> </textarea>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div class="card">

                <div class="card-body">
                    <p>Firmar a continuación:</p>
                    <div class="contenedor">

                        <div class="row">
                            <div class="col-md-12">
                                <canvas id="draw-canvas" width="300" height="300">
                                    No tienes un buen navegador.
                                </canvas>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">

                                <input type="button" class="btn btn-rounded btn-outline-primary" id="draw-clearBtn" value="Borrar Firma"></input>

                                <label hidden>Color</label>
                                <input type="color" id="color" hidden>
                                <label>Tamaño Puntero</label>
                                <input type="range" id="puntero" min="1" default="1" max="5" width="10%">


                            </div>

                        </div>


                    </div>
                    <input hidden type="text" id="Firma" asp-for="Input.Firma" />

                </div>
            </div>

        </div>

    </div>


    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <button type="button" id="Guardar" class="btn btn-rounded btn-outline-success" onclick="javascript: onGuardar()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</form>